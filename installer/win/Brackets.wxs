<?xml version='1.0' encoding="UTF-8"?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi' xmlns:util='http://schemas.microsoft.com/wix/UtilExtension'
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">

    <!--
        Variable references:
            $(var.*) are passed in on the command line from the Ant script (see -d arguments to candle)
            !(loc.*) are defined in Brackets_<locale>.wxl
            [*] are references to other elements within this file
    -->

    <!-- note: products with matching `UpgradeCode` guid will be upgraded in-place.  Consequently,
                do not change this guid unless you are starting a new major version of the product. -->
    <Product Id='*' UpgradeCode='CD12929F-070D-4485-BD00-214142A18ACA' Name='!(loc.ProductName)' Language='1033'
             Version='$(var.ProductVersionNumber)' Manufacturer='$(var.ProductManufacturer)'  >

        <Package Description='!(loc.ProductName)' Comments='Installer for !(loc.ProductName)'
                 Manufacturer='$(var.ProductManufacturer)' InstallerVersion='405' Compressed='yes'
                 Languages="1033,1036" Platform="x64" />

        <Media Id='1' Cabinet='product.cab' EmbedCab='yes' />

        <!-- defines upgrade experience for all releases related by the same UpgradeCode (above) -->
        <MajorUpgrade Schedule="afterInstallInitialize"
                      DowngradeErrorMessage="A later version of !(loc.ProductName) is already installed.  Setup will now exit." />

        <Property Id="ARPPRODUCTICON" Value="appicon.ico"/>
        <Icon Id="appicon.ico" SourceFile="appicon.ico"/>
        <Property Id="ALLUSERS" Value="1" />

        <DirectoryRef Id="INSTALLDIR" />

        <DirectoryRef Id="ProgramMenuFolder">
            <Component Id="StartMenuShortcut" Guid="{AD7D95F2-EF87-4779-8B54-EB34DF18AEAC}" Win64="yes" >
                <Shortcut Id="AppShortcut" Name="!(loc.ProductName)" Description="!(loc.ShortcutDescription)"
                          Target="[INSTALLDIR]\$(var.ExeName).exe" />
                <RegistryValue Root="HKCU" Key="Software\$(var.RegistryRoot)" Name="installed" Type="integer"
                               Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <Component Id="FileAssociations" Guid="{3E2F8774-A442-4E27-BCDD-41F04DC6E7D1}" Directory="INSTALLDIR" KeyPath="yes" Win64="yes">
            <!-- Capabilities keys for Vista/7 "Set Program Access and Defaults" -->
            <RegistryValue Root="HKLM" Key="SOFTWARE\$(var.RegistryRoot)\Capabilities" Name="ApplicationIcon"
                           Value="[INSTALLDIR]$(var.ExeName).exe,0" Type="string" />
            <RegistryValue Root="HKLM" Key="SOFTWARE\$(var.RegistryRoot)\Capabilities" Name="ApplicationName"
                           Value="!(loc.ProductName)" Type="string" />
            <RegistryValue Root="HKLM" Key="SOFTWARE\RegisteredApplications" Name="!(loc.ProductName)"
                           Value="SOFTWARE\$(var.RegistryRoot)\Capabilities" Type="string" />

            <!-- File associations -->
            <?define SupportedFiletypes=lime;limecraft?>

            <?foreach filetype in $(var.SupportedFiletypes)?>
            <!-- associate program with file type -->
            <RegistryValue Root="HKLM" Key="SOFTWARE\$(var.RegistryRoot)\Capabilities\FileAssociations"
                           Value="!(loc.ProductName) FileExt" Name=".$(var.filetype)" Type="string" />

            <!-- associate each supported filetype with application -->
            <RegistryValue Root="HKCR" Key=".$(var.filetype)\OpenWithProgids" Value=""
                           Name="!(loc.ProductName) FileExt" Type="string" />
            <?endforeach?>

            <!-- create ProgId entry -->
            <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\!(loc.ProductName) FileExt\shell\open\command"
                           Value="&quot;[INSTALLDIR]$(var.ExeName).exe&quot; &quot;%1&quot;" Type="string" />
            <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\!(loc.ProductName) FileExt\DefaultIcon"
                           Value="[INSTALLDIR]$(var.ExeName).exe,0" Type="string" />
            <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\!(loc.ProductName) FileExt\shell\open"
                           Name="FriendlyAppName" Value="!(loc.ProductName)" Type="string" />
        </Component>

        <!-- Start Menu Shortcuts-->
        <UIRef Id="WixUI_MyInstallDir" />
        <UIRef Id="WixUI_ErrorProgressText" />

        <!-- Launch app after install -->
        <!--
                <Property Id="LAUNCHAPPONEXIT" Value="1" />
                <Property Id="WixShellExecTarget" Value="[#fil7EE01D0693DA0F92C26C5F3007D1BF2C]" />
                <CustomAction Id="LaunchApplication" FileKey="fil7EE01D0693DA0F92C26C5F3007D1BF2C" ExeCommand=""
                              Execute="immediate" Impersonate="yes" Return="asyncNoWait" />
        -->
        <UI>
            <Publish Dialog="MyExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <!--
                        <Publish Dialog="MyExitDialog" Control="Finish" Order="1" Event="DoAction"
                                 Value="LaunchApplication">LAUNCHAPPONEXIT=1 and NOT INSTALLED AND NOT REMOVE="ALL"</Publish>
            -->
        </UI>

        <!-- Add image assets -->
        <WixVariable Id="WixUIBannerBmp" Value="win_install_banner.jpg" />

        <!--Setup Folder Structure -->
        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='ProgramFiles64Folder'>
                <Directory Id='INSTALLDIR' Name='!(loc.ShortProductName)'/>
            </Directory>
            <Directory Id="ProgramMenuFolder"/>
        </Directory>

        <!-- add MSVCRT merge modules -->
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist100" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC100_CRT_x86.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist100" Title="Visual C++ 10 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist100"/>
        </Feature>

        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist110" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC110_CRT_x86.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist110" Title="Visual C++ 11 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist110"/>
        </Feature>

        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist120" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC120_CRT_x86.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist120" Title="Visual C++ 12 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist120"/>
        </Feature>

        <!-- also add MSCVRT 64bit merge modules -->
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist100_64" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC100_CRT_x64.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist100_64" Title="Visual C++ 10 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist100_64"/>
        </Feature>

        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist110_64" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC110_CRT_x64.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist110_64" Title="Visual C++ 11 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist110_64"/>
        </Feature>

        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist120_64" SourceFile="$(env.CommonProgramFiles)\Merge Modules\Microsoft_VC120_CRT_x64.msm" DiskId="1" Language="0"/>
        </DirectoryRef>

        <Feature Id="VCRedist120_64" Title="Visual C++ 12 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist120_64"/>
        </Feature>

        <!-- Set default install location -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <!-- Install Files -->
        <Feature Id="MainApplication" Title="Main Application" Level="1">
            <!-- From devmanager.wxs -->
            <ComponentGroupRef Id='BRACKETSHARVESTMANAGER'/>

            <ComponentRef  Id='StartMenuShortcut' />

            <ComponentRef  Id='FileAssociations' />
        </Feature>

        <SetProperty Id="ARPINSTALLLOCATION" Value="[INSTALLDIR]" After="CostFinalize" />
    </Product>
</Wix>

        <!-- filD0C88F09CF264F61C7551B69762FB244 -->

